# TCP/IP
TCP/IP 란 인터넷에서 컴퓨터들이 서로 정보를 주고 받는데 쓰이는 프로토콜의 집합 으로 정의할 수 있다.

TCP/IP 는 Application Layer, Transport Layer, Internet Layer, Network Access Layer 로 구성되어 있다.

#### Application Layer
특정 서비스를 제공하기 위해 애플리케이션 끼리 정보를 주고 받을수 있게 해준다.

브라우저가 웹사이트를 요청하는것을 예로 들 수 있다.

사용돼는 프로토콜에는 다음과 같다.
1. FTP
2. HTTP
3. SSH
4. SMTP
5. Telnet
6. DNS
7. ...

#### Transport Layer
송신된 데이터를 수신측 애플리케이션에 확실히 전달하게 해준다.

네트워크 통신을 하는 애플리케이션들은 포트번호를 사용하게 돼는데, 이때 Transport Layer 가 포트번호를 사용하여 애플리케이션을 찾아 주는 역할을 한다.

사용돼는 프로토콜에는 다음과 같다.
1. TCP
2. UDP
3. RTP
4. RTCP
5. ...

#### Internet Layer
수신 측 까지 데이터를 전달하기 위해 사용됀다.

통신측, 수신측의 IP 주소를 바탕으로 올바른 목적지로 찾아갈 수 있게 해준다.

사용돼는 프로토콜에는 다음과 같다.
1. IP
2. ARP
3. ICMP
4. RARP
5. OSPF
6. ...

#### Network Access Layer
네트워크에 직접 연결된 기기 간의 데이터 전송을 도와준다.

여기선 물리적 주소인 MAC 주소를 사용한다.

사용돼는 프로토콜에는 다음과 같다.
1. Ethernet
2. PPP
3. Token Ring
4. ...

***

# `www.google.com` 을 웹브라우저에 입력하면 무슨일이 일어날까?
웹브라우저에 `www.google.com` 을 입력한다는 것은 구글 웹서버에 80포트로 아래와 같은 HTTP Request 메시지를 보내는 것이다.

해당 요청을 인터넷을 통해 구글 서버로 전달하기 위해 패킷을 만들어야 한다.

패킷에는 각 계층에 필요한 정보들이 담겨야 한다.

이후 차례대로 Transport Layer, Internet Layer, Network Access Layer 에서 각각의 정보를 추가하여 패킷을 만들어 나간다.

TCP 패킷의 헤더는 이렇게 생겼다.

중요한것것은 SP와 DP로 시작 포트 번호와 목적지 포트 번호를 말한다.

그다음 IP 헤더다.

여기서도 중요한 정보는 SA와 DA 이다.

즉, 시작 IP주소와 목적지 IP 주소다, 하지만 이때는 목적지 IP 주소를 정확히 알지 못한다. 정확히는 `www.google.com` 이라는 도메인 주소만 알 뿐이다.

그러므로 DNS 서버에 `www.google.com` 을 요청하여 IP 주소를 알아내야 한다.

브라우저는 OS 에게 domaion에 대한 ip 주소를 알고 싶다고 요청한다.

그러면 OS 에서 DNS 서버에 `www.google.com` 을 요청한다.

그렇다면 OIS 는 어떻게 DNS 서버를 알고 있는가?

사실 DNS 서버의 IP 주소는 OS 에서 설정해 놓은 것이다.

자신이 사용하고 있는 컴퓨터에서 확인이 가능하다.

여기서 말하는 DNS 또한 HTTP 같은 애플리케이션 계층 프로토콜 이다.

그리고 DNS는 53번 포트를 사용한다.

DNS는 domain이 담긴 쿼리를 domain 서버에 보낸다.

그렇다면 domain 서버가 IP 주소를 응답하게 해준다.

DNS는 Transport Layer 에서 UDP 프로토콜을 사용한다.

이러한 과정을 통해 성공적으로 도메인 이름에 대한 IP 주소를 받아오게 된다.

마지막으로 Ethernet 프로토콜에 대한 헤더를 만들어야 하는데 아직 MAC 주소를 모른다.

우린 지금까지 구글서버에 대한 정보가 필요했고, IP 주소를 알아내었다.

여기서 말하는 MAC 주소는 구글 MAC 주소 대신 물리적으로 연결된 우리집 공유기의 MAC 주소가 필요하다.

이 공유기를 다른 네트워크와 연결을 가능하게 해주니 gateway 라고도 한다.

우린 이미 gateway 에 대한 정보를 알고 있다.

`netstat -nr` 명령어를 통해 확인이 가능하다.

그럼 어떻게 IP 주소를 통해 MAC 주소를 알수 있을까?

ARP 프로토콜을 사용하면 된다.

ARP 프로토콜은 IP 주소를 MAC 주소로 바꾸어 주는 주소해석 프로토콜 이라 할 수 있다.

이렇게 MAC 주소를 알아내면 패킷을 만들어서 네트워크로 보내기만 하면 된다.

하지만 우리가 사용하는 TCP 프로토콜에는 한가지 작업을 더 해줘야 한다.

TCP 프로토콜은 데이터를 전송하기 전에, 송신측과 수신측이 서로 연결되는 작업이 필요하다.

이러한 작업을 3-way handshake 라고 한다.

이를 수행하기 위해선 TCP 헤드에 표시된 플래그 들을 사용한다. 이러한 플래드 들을 컨트롤 비트라고 부른다.

3-way handshake 에서는 SYN 과 ACK 플래그가 사용 된다.

먼저 클라이언트는 서버에게 접속을 요청하는 SYN 패킷을 보낸다.

서버는 SYN 요청을 받고, 클라이언트에게 요청을 수락한다는 ACK와 SYN 플래그가 설정된 패킷을 보낸다.

클라이언트는 다시 서버에게 ACK을 보낸다. 이제부터 연결이 이루어지고 데이터가 오가게 된다.

한가지 부가적으로 설명하자면 내가 사용하는 컴퓨터는 Private IP를 사용하고 있다.

Private IP는 외부 네트워크와 통신을 할 수 없다.

그렇기에 공유기를 통해 Public IP로 변환되어야 한다.

이러한 작업을 NAT(Network Address Translation) 이라고 한다.

우리집 공유기를 거치고 나서 여러 라우터를 거쳐 구글 서버에 도착하게 된다.

그렇다면 패킷에 기록된 목적지 IP를 가지고 구글 서버의 MAC 주소를 얻어오게 된다.

이제부터 데이터가 물리적으로 전달 가능하다.

Network Access Layer 에서 MAC 주소와 Internet Layer 에서 IP 주소를 확인했으니 이제 Transport Layer 에서 포트 번호를 확인하면 된다.

응답을 하는 구글서버의 애플리케이션이 80번 포트를 이용하고 있기 때문에 우리도 80번 포트에 데이터를 전달해 줘야 하는것을 알 수 있다.

이제 Application Layer 에서 HTTP Request 를 받고 적절한 Response를 보내주면 된다.

이제 응답이 끝났으니 TCP 연결이 끊어지게 된다. 연결으 끊어질때는 4번에 걸쳐 진행돼고 이를 4-way handshake 라고 한다.

참고로 TCP는 신뢰할 수 있는 프로토콜이다. 현재 인터넷 세상은 정말 거대한 데이터가 오가고 이 데이터들은 정말 많은 패킷들로 이루어져 있다.

이렇게 방대한 패킷들이 복잡한 네트워크를 통해 전달되는데, 이때 TCP는 패킷의 손실을 감지하고 재전송을 요청하는 등의 기능을 제공한다.

대표적으로 흐름제어, 오류제어, 혼잡제어 등이 있다.




